---
title: Stability of species within ecological communities
format: pdf
jupyter: julia-1.10
bibliography: references.bib
---

```{julia}
#| echo: false
#| output: false

using Pkg; Pkg.activate(".")
using AlgebraOfGraphics
using CairoMakie
using DataFrames
using DifferentialEquations
using Distributions
using LinearAlgebra
using LotkaVolterra
using Random
set_aog_theme!()

```

We investigate the correlation between species response to a pulse 
and press disturbance.
In particalar, we are interested in understanding how 
the types of interactions occuring within
the community affect the correlation between these two stability facets.

First, we define the species press to press as 
the relative variation in carrying capacity that 
leads to the extinction of the species.

$$ \Omega_i = \frac{\delta K_i}{K_i} = - \eta_i^* (\frac{\partial N_i}{\partial K_i})^{-1} $$
where $N_i$ is the abundance of species $i$,
and $\eta_i^* = \frac{N_i^*}{K_i}$ is the relative yield of species $i$.

```{julia}

function B_mixed(S; mu = -0.1, sigma=0.1) 
    B = rand(Normal(mu, sigma), S, S)
    B[diagind(B)] .= -1
    B
end

S = 50 # Number of species.

df = DataFrame(; resistance = Float64[], eta = Float64[], reactivity = Float64[], mu = String[])
for mu in [-0.15, 0.0]
    create_interaction_matrix(S) = B_mixed(S; mu)
    K = rand(Uniform(1, S), S) # Carrying capacities.
    c = create_communities(S, 1; create_interaction_matrix)[S][1]
    eta = equilibrium_abundance(c)
    B = c.A
    A = Diagonal(K) * B * Diagonal(1 ./ K)
    V = -inv(A) # Sensitivity matrix.
    resistance = eta .* diag(V)
    reactivity = get_reactivity(c)
    mu_str = "Î¼ = $mu"
    append!(df, DataFrame(; resistance, eta, reactivity, mu = mu_str))
end

plt = data(df) * 
    mapping(:reactivity => "Reactivity to pulse", :resistance => "Resistance to press", layout = :mu) *
    visual(Scatter)
draw(plt, facet = (; linkxaxes = :none, linkyaxes = :none))

```
